# This file is the fluentd configuration entrypoint. Edit with care.

    @include configs.d/openshift/system.conf

    # In each section below, pre- and post- includes don't include anything initially;
    # they exist to enable future additions to openshift conf as needed.

    ## sources
    ## ordered so that syslog always runs last...
    @include configs.d/openshift/input-pre-*.conf
    @include configs.d/dynamic/input-docker-*.conf
    @include configs.d/dynamic/input-syslog-*.conf
    @include configs.d/openshift/input-post-*.conf
    ##

<label @INGRESS>
    ## filters
      @include configs.d/openshift/filter-pre-*.conf
      @include configs.d/openshift/filter-retag-journal.conf
      @include configs.d/openshift/filter-k8s-meta.conf
      @include configs.d/openshift/filter-kibana-transform.conf
      @include configs.d/openshift/filter-k8s-flatten-hash.conf
      @include configs.d/openshift/filter-k8s-record-transform.conf
      @include configs.d/openshift/filter-syslog-record-transform.conf
      @include configs.d/openshift/filter-viaq-data-model.conf
      @include configs.d/openshift/filter-post-*.conf
    ##
</label>

<label @OUTPUT>
    ## matches
      @include configs.d/openshift/output-pre-*.conf
      @include configs.d/openshift/output-operations.conf
      @include configs.d/openshift/output-applications.conf
      # no post - applications.conf matches everything left
    ##
</label>

<match **>
      @type copy
      deep_copy true
      <store>
            @type s3
            aws_key_id "#{ENV['LOGGING_USERNAME']}"
            aws_sec_key "#{ENV['LOGGING_PASSWORD']}"
            s3_bucket "{{ getupcloud_logging_storage_s3_bucket }}"
            s3_region "{{ getupcloud_logging_storage_s3_region }}"
            path "#{ENV['S3_LOGS_BUCKET_PREFIX']}"
            buffer_path /var/log/fluent/s3
            s3_object_key_format %{path}%{time_slice}/{{ getupcloud_cluster_name }}-%{index}.%{file_extension}
            time_slice_format %Y%m%d-%H
            time_slice_wait 10m
            flush_interval 60s
            buffer_chunk_limit 256m
      </store>
</match>